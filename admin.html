<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrace - Vƒõdci zjistili</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1VKMTJ7HFT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-1VKMTJ7HFT');
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="config.js"></script>
    <script>
        // Fallback pro config.local.js pokud neexistuje online
        if (!window.RESEND_CONFIG || window.RESEND_CONFIG.apiKey === 'PLACEHOLDER_API_KEY') {
            console.warn('config.local.js nenalezen, API kl√≠ƒç bude naƒçten z environment variables');
            window.RESEND_CONFIG = {
                apiKey: 'ENVIRONMENT_API_KEY', // Naƒçte se z Netlify environment variables
                fromEmail: 'newsletter@vedcizjistili.cz',
                fromName: 'Vƒõdci zjistili'
            };
        }
    </script>
    <script src="database.js"></script>
    <script src="newsletter-generator.js"></script>
    <script src="resend-email.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1><a href="index.html" style="text-decoration: none; color: inherit;">Vƒõdci zjistili</a></h1>
            <nav>
                <a href="index.html">Dom≈Ø</a>
                <a href="archiv.html">Arch√≠v</a>
                <a href="about.html">O projektu</a>
                <a href="admin.html">Administrace</a>
            </nav>
        </div>
    </header>

    <!-- Login formul√°≈ô -->
    <div id="login-container" style="max-width: 400px; margin: 50px auto; padding: 2rem; background: #f8f9fa; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h2 style="text-align: center; margin-bottom: 2rem; color: #2c3e50;">P≈ôihl√°≈°en√≠ do administrace</h2>
        <form id="login-form">
            <div style="margin-bottom: 1rem;">
                <label for="username" style="display: block; margin-bottom: 0.5rem; color: #34495e; font-weight: 500;">U≈æivatelsk√© jm√©no:</label>
                <input type="text" id="username" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
            </div>
            <div style="margin-bottom: 1.5rem;">
                <label for="password" style="display: block; margin-bottom: 0.5rem; color: #34495e; font-weight: 500;">Heslo:</label>
                <input type="password" id="password" required style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
            </div>
            <button type="submit" style="width: 100%; padding: 0.75rem; background: #3498db; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background 0.2s;">
                P≈ôihl√°sit se
            </button>
        </form>
        <div id="login-error" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #ffebee; color: #c62828; border-radius: 4px; text-align: center;">
            Nespr√°vn√© p≈ôihla≈°ovac√≠ √∫daje.
        </div>
    </div>

    <main id="admin-content" style="display: none;">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="color: #2c3e50; font-weight: 300;">Administrace</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label for="newsletter-toggle" style="color: #2c3e50; font-size: 0.9rem;">Newsletter sekce:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="newsletter-toggle" checked>
                            <span class="slider"></span>
                        </label>
                        <span id="newsletter-status" style="color: #27ae60; font-size: 0.9rem; font-weight: 500;">Zapnuto</span>
                    </div>
                    <button onclick="logout()" style="padding: 0.5rem 1rem; background: #95a5a6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Odhl√°sit se
                    </button>
                </div>
            </div>
            
            <div class="admin-form">
                <h3 style="margin-bottom: 1.5rem; color: #2c3e50; font-weight: 400;">P≈ôidat nov√Ω ƒçl√°nek</h3>
                
                <form id="article-form">
                    <div class="form-group">
                        <label for="article-date">Datum:</label>
                        <input type="date" id="article-date" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="article-title">Nadpis ƒçl√°nku:</label>
                        <input type="text" id="article-title" name="title" placeholder="Zadejte nadpis ƒçl√°nku..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="article-excerpt">Kr√°tk√Ω v√Ωtah (pro arch√≠v):</label>
                        <textarea id="article-excerpt" name="excerpt" placeholder="Struƒçn√Ω popis ƒçl√°nku pro zobrazen√≠ v arch√≠vu..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="article-image">Obr√°zek (voliteln√Ω):</label>
                        <input type="file" id="article-image" name="image" accept="image/*">
                        <div id="image-preview" style="margin-top: 1rem; display: none;">
                            <img id="preview-img" style="max-width: 300px; max-height: 200px; border-radius: 4px; border: 1px solid #ddd;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="source-title">N√°zev zdroje (voliteln√Ω):</label>
                        <input type="text" id="source-title" name="source_title" placeholder="nap≈ô. Nature, MIT News...">
                    </div>
                    
                    <div class="form-group">
                        <label for="source-url">Odkaz na zdroj (voliteln√Ω):</label>
                        <input type="url" id="source-url" name="source_url" placeholder="https://...">
                    </div>
                    
                    <div class="form-group">
                        <label for="article-content">Obsah ƒçl√°nku:</label>
                        <div id="quill-editor" style="height: 300px;"></div>
                        <textarea id="article-content" name="content" style="display: none;"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">Publikovat ƒçl√°nek</button>
                </form>
            </div>
            
            <!-- Formul√°≈ô pro editaci ƒçl√°nku (skryt√Ω) -->
            <div id="edit-form-container" class="admin-form" style="margin-top: 2rem; display: none;">
                <h3 style="margin-bottom: 1.5rem; color: #2c3e50; font-weight: 400;">Editovat ƒçl√°nek</h3>
                
                <form id="edit-article-form">
                    <input type="hidden" id="edit-article-id" name="id">
                    
                    <div class="form-group">
                        <label for="edit-article-date">Datum:</label>
                        <input type="date" id="edit-article-date" name="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-article-title">Nadpis ƒçl√°nku:</label>
                        <input type="text" id="edit-article-title" name="title" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-article-excerpt">Kr√°tk√Ω v√Ωtah (pro arch√≠v):</label>
                        <textarea id="edit-article-excerpt" name="excerpt" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-article-image">Zmƒõnit obr√°zek (voliteln√Ω):</label>
                        <input type="file" id="edit-article-image" name="image" accept="image/*">
                        <div id="edit-current-image" style="margin-top: 1rem; display: none;">
                            <p style="color: #666; font-size: 0.9rem;">Aktu√°ln√≠ obr√°zek:</p>
                            <img id="edit-current-img" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 1px solid #ddd;">
                        </div>
                        <div id="edit-image-preview" style="margin-top: 1rem; display: none;">
                            <p style="color: #666; font-size: 0.9rem;">Nov√Ω obr√°zek:</p>
                            <img id="edit-preview-img" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 1px solid #ddd;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-source-title">N√°zev zdroje (voliteln√Ω):</label>
                        <input type="text" id="edit-source-title" name="source_title">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-source-url">Odkaz na zdroj (voliteln√Ω):</label>
                        <input type="url" id="edit-source-url" name="source_url">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-article-content">Obsah ƒçl√°nku:</label>
                        <div id="edit-quill-editor" style="height: 300px;"></div>
                        <textarea id="edit-article-content" name="content" style="display: none;"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn">Ulo≈æit zmƒõny</button>
                        <button type="button" class="btn" style="background-color: #95a5a6;" onclick="cancelEdit()">Zru≈°it</button>
                    </div>
                </form>
            </div>

            <!-- Formul√°≈ô pro editaci str√°nky O projektu -->
            <div class="admin-form" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1.5rem; color: #2c3e50; font-weight: 400;">Editace str√°nky O projektu</h3>
                
                <form id="about-page-form">
                    <div class="form-group">
                        <label for="about-title">Nadpis str√°nky:</label>
                        <input type="text" id="about-title" name="title" placeholder="Nadpis str√°nky O projektu..." required>
                    </div>
                    
                    <div class="form-group">
                        <label for="about-content">Obsah str√°nky:</label>
                        <div id="about-quill-editor" style="height: 300px;"></div>
                        <textarea id="about-content" name="content" style="display: none;"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">Ulo≈æit str√°nku O projektu</button>
                </form>
                
                <div id="about-loading" style="display: none; text-align: center; padding: 1rem; color: #666;">
                    Naƒç√≠t√°n√≠ obsahu str√°nky...
                </div>
            </div>

            <!-- Newsletter sekce -->
            <div class="admin-form" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1.5rem; color: #2c3e50; font-weight: 400;">Newsletter</h3>
                
                <!-- Newsletter statistiky -->
                <div id="newsletter-stats" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">Statistiky</h4>
                    <div id="stats-loading" style="text-align: center; color: #666;">Naƒç√≠t√°n√≠ statistik...</div>
                    <div id="stats-content" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="active-subscribers">0</div>
                                <div style="font-size: 0.9rem; color: #666;">Aktivn√≠ odbƒõratel√©</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #27ae60;" id="total-emails">0</div>
                                <div style="font-size: 0.9rem; color: #666;">Odeslan√Ωch email≈Ø</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: #f39c12;" id="total-recipients">0</div>
                                <div style="font-size: 0.9rem; color: #666;">Celkem doruƒçeno</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Odesl√°n√≠ newsletteru -->
                <div style="background: #fff; border: 1px solid #e5e5e5; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">Odeslat newsletter</h4>
                    <div style="margin-bottom: 1rem;">
                        <label for="newsletter-article-select" style="display: block; margin-bottom: 0.5rem; color: #333; font-weight: 500;">Vyberte ƒçl√°nek:</label>
                        <select id="newsletter-article-select" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                            <option value="">Naƒç√≠t√°n√≠ ƒçl√°nk≈Ø...</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <button id="send-newsletter-btn" class="btn" onclick="sendNewsletter()" disabled>
                            Odeslat newsletter
                        </button>
                        <span id="newsletter-send-status" style="color: #666; font-size: 0.9rem;"></span>
                    </div>
                    <div id="newsletter-preview" style="margin-top: 1rem; display: none;">
                        <h5 style="color: #2c3e50; margin-bottom: 0.5rem;">N√°hled emailu:</h5>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; max-height: 300px; overflow-y: auto;">
                            <div id="preview-content"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Spr√°va odbƒõratel≈Ø -->
                <div style="background: #fff; border: 1px solid #e5e5e5; padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">Spr√°va odbƒõratel≈Ø</h4>
                    
                    <!-- P≈ôid√°n√≠ nov√©ho odbƒõratele -->
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem;">
                        <h5 style="color: #2c3e50; margin-bottom: 0.5rem;">P≈ôidat nov√©ho odbƒõratele</h5>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="email" id="add-subscriber-email" placeholder="email@example.com" style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <button onclick="addSubscriberFromAdmin()" class="btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                P≈ôidat
                            </button>
                        </div>
                        <div id="add-subscriber-message" style="margin-top: 0.5rem; font-size: 0.9rem; display: none;"></div>
                    </div>
                    
                    <!-- Seznam odbƒõratel≈Ø -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h5 style="color: #2c3e50; margin: 0;">Seznam v≈°ech odbƒõratel≈Ø</h5>
                        <button id="toggle-subscribers-btn" class="btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="toggleSubscribersList()">
                            Zobrazit seznam
                        </button>
                    </div>
                    <div id="subscribers-list" style="display: none;">
                        <div id="subscribers-loading" style="text-align: center; color: #666; padding: 1rem;">Naƒç√≠t√°n√≠ seznamu...</div>
                        <div id="subscribers-content" style="display: none;">
                            <!-- Seznam se naƒçte dynamicky -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-form" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1.5rem; color: #2c3e50; font-weight: 400;">Spr√°va existuj√≠c√≠ch ƒçl√°nk≈Ø</h3>
                
                <div id="loading-articles" style="text-align: center; padding: 1.5rem; color: #666;">
                    Naƒç√≠t√°n√≠ ƒçl√°nk≈Ø...
                </div>
                
                <div id="articles-list" style="margin-top: 1.5rem; display: none;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">Aktu√°lnƒõ publikovan√© ƒçl√°nky:</h4>
                    <ul id="articles-container" style="list-style: none; padding: 0;">
                        <!-- ƒål√°nky se naƒçtou dynamicky -->
                    </ul>
                </div>
                
                <div id="no-articles" style="display: none; text-align: center; padding: 1.5rem; color: #666;">
                    ≈Ω√°dn√© ƒçl√°nky nejsou k dispozici.
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Vƒõdci zjistili. Ka≈æd√Ω den nƒõco nov√©ho.</p>
        </div>
    </footer>

    <script>
        // P≈ôihla≈°ovac√≠ √∫daje (v produkci by mƒõly b√Ωt bezpeƒçnƒõji ulo≈æeny)
        const ADMIN_CREDENTIALS = {
            username: 'milos',
            password: 'vedci2025!'
        };

        // Kontrola p≈ôihl√°≈°en√≠ p≈ôi naƒçten√≠ str√°nky
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            
            // Event listener pro login formul√°≈ô
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        });

        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
            
            if (isLoggedIn) {
                showAdminContent();
            } else {
                showLoginForm();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminContent();
            } else {
                document.getElementById('login-error').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('login-error').style.display = 'none';
                }, 3000);
            }
        }

        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            showLoginForm();
        }

        function showLoginForm() {
            document.getElementById('login-container').style.display = 'block';
            document.getElementById('admin-content').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showAdminContent() {
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            initializeAdminContent();
        }

        // Inicializace admin obsahu
        function initializeAdminContent() {
            // Inicializace Supabase klienta
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
            
            // Inicializace datab√°ze t≈ô√≠dy
            window.articleDB.init(supabaseClient);
            
            // Inicializace newsletter toggle
            initializeNewsletterToggle();

            // Inicializace Quill editor≈Ø a naƒçten√≠ ƒçl√°nk≈Ø
            if (!window.quill) {
                // Inicializace Quill rich text editoru pro nov√© ƒçl√°nky
                window.quill = new Quill('#quill-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['link'],
                            ['clean']
                        ]
                    },
                    placeholder: 'Napi≈°te obsah ƒçl√°nku...'
                });

                // Inicializace Quill editoru pro editaci ƒçl√°nk≈Ø
                window.editQuill = new Quill('#edit-quill-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['link'],
                            ['clean']
                        ]
                    },
                    placeholder: 'Upravte obsah ƒçl√°nku...'
                });

                // Inicializace Quill editoru pro str√°nku O projektu
                window.aboutQuill = new Quill('#about-quill-editor', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['link'],
                            ['clean']
                        ]
                    },
                    placeholder: 'Upravte obsah str√°nky O projektu...'
                });

                // Preview obr√°zku
                document.getElementById('article-image').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const preview = document.getElementById('image-preview');
                    const img = document.getElementById('preview-img');
                    
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            img.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        preview.style.display = 'none';
                    }
                });
                
                // Preview obr√°zku pro editaci
                document.getElementById('edit-article-image').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const preview = document.getElementById('edit-image-preview');
                    const img = document.getElementById('edit-preview-img');
                    
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            img.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        preview.style.display = 'none';
                    }
                });

                // P≈ôipojen√≠ event listeneru pro formul√°≈ôe
                document.getElementById('article-form').addEventListener('submit', handleFormSubmit);
                document.getElementById('edit-article-form').addEventListener('submit', handleEditFormSubmit);
                document.getElementById('about-page-form').addEventListener('submit', handleAboutPageSubmit);
            }

            loadArticles();
            loadAboutPage();
            loadNewsletterData();
            
            // Nastaven√≠ dne≈°n√≠ho data jako v√Ωchoz√≠
            document.getElementById('article-date').valueAsDate = new Date();
        }

        // Funkce pro zpracov√°n√≠ formul√°≈ôe
        async function handleFormSubmit(e) {
            e.preventDefault();
            console.log('Formul√°≈ô odesl√°n!'); // Debug zpr√°va
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                const formData = new FormData(this);
                
                // Z√≠sk√°n√≠ obsahu z Quill editoru
                const content = window.quill.root.innerHTML;
                console.log('Obsah z editoru:', content); // Debug zpr√°va
                
                // Validace obsahu - kontrola zda nen√≠ pr√°zdn√Ω
                const textContent = window.quill.getText().trim();
                if (textContent.length === 0) {
                    alert('Pros√≠m vypl≈àte obsah ƒçl√°nku.');
                    return;
                }
                
                submitBtn.textContent = 'Publikuji...';
                submitBtn.disabled = true;
                
                const articleData = {
                    date: formData.get('date'),
                    title: formData.get('title'),
                    excerpt: formData.get('excerpt'),
                    content: content,
                    source_url: formData.get('source_url'),
                    source_title: formData.get('source_title')
                };
                
                console.log('Data ƒçl√°nku:', articleData); // Debug zpr√°va
                
                // Nahr√°n√≠ obr√°zku pokud byl vybr√°n
                const imageFile = formData.get('image');
                if (imageFile && imageFile.size > 0) {
                    console.log('Nahr√°v√°m obr√°zek:', imageFile.name);
                    submitBtn.textContent = 'Nahr√°v√°m obr√°zek...';
                    const uploadResult = await window.articleDB.uploadImage(imageFile);
                    
                    if (uploadResult.success) {
                        articleData.image_url = uploadResult.url;
                        console.log('Obr√°zek nahr√°n:', uploadResult.url);
                    } else {
                        console.error('Chyba nahr√°v√°n√≠:', uploadResult.error);
                        alert('Chyba p≈ôi nahr√°v√°n√≠ obr√°zku: ' + uploadResult.error);
                        return;
                    }
                }
                
                submitBtn.textContent = 'Ukl√°d√°m ƒçl√°nek...';
                const result = await window.articleDB.addArticle(articleData);
                console.log('V√Ωsledek ulo≈æen√≠:', result);
                
                if (result.success) {
                    alert('ƒål√°nek byl √∫spƒõ≈°nƒõ publikov√°n!');
                    this.reset();
                    window.quill.setContents([]); // Vyƒçistit editor
                    document.getElementById('image-preview').style.display = 'none';
                    document.getElementById('article-date').valueAsDate = new Date();
                    await loadArticles(); // Obnovit seznam ƒçl√°nk≈Ø
                } else {
                    alert('Chyba p≈ôi publikov√°n√≠ ƒçl√°nku: ' + result.error);
                }
            } catch (error) {
                console.error('Chyba p≈ôi publikov√°n√≠ ƒçl√°nku:', error);
                alert('Do≈°lo k chybƒõ p≈ôi publikov√°n√≠ ƒçl√°nku.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Funkce pro naƒçten√≠ ƒçl√°nk≈Ø
        async function loadArticles() {
            const loadingEl = document.getElementById('loading-articles');
            const articlesListEl = document.getElementById('articles-list');
            const noArticlesEl = document.getElementById('no-articles');
            const containerEl = document.getElementById('articles-container');

            try {
                const articles = await window.articleDB.getAllArticles();
                
                loadingEl.style.display = 'none';
                
                if (articles && articles.length > 0) {
                    containerEl.innerHTML = articles.map(article => `
                        <li style="padding: 0.5rem 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${window.articleDB.formatDate(article.date)}:</strong> 
                                ${article.title.length > 60 ? article.title.substring(0, 60) + '...' : article.title}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.8rem;" onclick="editArticle(${article.id})">
                                    Editovat
                                </button>
                                <button class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.8rem; background-color: #e74c3c;" onclick="deleteArticle(${article.id}, '${article.title.replace(/'/g, "\\'")}')" title="Smazat ƒçl√°nek">
                                    Smazat
                                </button>
                            </div>
                        </li>
                    `).join('');
                    articlesListEl.style.display = 'block';
                } else {
                    noArticlesEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ƒçl√°nk≈Ø:', error);
                loadingEl.style.display = 'none';
                noArticlesEl.style.display = 'block';
                noArticlesEl.textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠ ƒçl√°nk≈Ø.';
            }
        }

        // Funkce pro editaci ƒçl√°nku
        async function editArticle(articleId) {
            console.log('Naƒç√≠t√°m ƒçl√°nek pro editaci:', articleId);
            
            try {
                const article = await window.articleDB.getArticleById(articleId);
                if (!article) {
                    alert('ƒål√°nek se nepoda≈ôilo naƒç√≠st.');
                    return;
                }
                
                // Naplnƒõn√≠ formul√°≈ôe daty
                document.getElementById('edit-article-id').value = article.id;
                document.getElementById('edit-article-date').value = window.articleDB.formatDatetime(article.date);
                document.getElementById('edit-article-title').value = article.title;
                document.getElementById('edit-article-excerpt').value = article.excerpt;
                document.getElementById('edit-source-title').value = article.source_title || '';
                document.getElementById('edit-source-url').value = article.source_url || '';
                
                // Nastaven√≠ obsahu v Quill editoru
                window.editQuill.root.innerHTML = article.content;
                
                // Zobrazen√≠ aktu√°ln√≠ho obr√°zku pokud existuje
                const currentImageEl = document.getElementById('edit-current-image');
                const currentImgEl = document.getElementById('edit-current-img');
                if (article.image_url) {
                    currentImgEl.src = article.image_url;
                    currentImageEl.style.display = 'block';
                } else {
                    currentImageEl.style.display = 'none';
                }
                
                // Skryt√≠ preview nov√©ho obr√°zku
                document.getElementById('edit-image-preview').style.display = 'none';
                
                // Zobrazen√≠ editaƒçn√≠ho formul√°≈ôe
                document.getElementById('edit-form-container').style.display = 'block';
                
                // Skrolov√°n√≠ k formul√°≈ôi
                document.getElementById('edit-form-container').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ƒçl√°nku:', error);
                alert('Do≈°lo k chybƒõ p≈ôi naƒç√≠t√°n√≠ ƒçl√°nku.');
            }
        }
        
        // Funkce pro zru≈°en√≠ editace
        function cancelEdit() {
            document.getElementById('edit-form-container').style.display = 'none';
            document.getElementById('edit-article-form').reset();
            window.editQuill.setContents([]);
        }
        
        // Zpracov√°n√≠ formul√°≈ôe pro editaci ƒçl√°nku
        async function handleEditFormSubmit(e) {
            e.preventDefault();
            console.log('Editaƒçn√≠ formul√°≈ô odesl√°n!');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                const formData = new FormData(this);
                const articleId = formData.get('id');
                
                // Z√≠sk√°n√≠ obsahu z Quill editoru
                const content = window.editQuill.root.innerHTML;
                
                // Validace obsahu
                const textContent = window.editQuill.getText().trim();
                if (textContent.length === 0) {
                    alert('Pros√≠m vypl≈àte obsah ƒçl√°nku.');
                    return;
                }
                
                submitBtn.textContent = 'Ukl√°d√°m zmƒõny...';
                submitBtn.disabled = true;
                
                const articleData = {
                    date: formData.get('date'),
                    title: formData.get('title'),
                    excerpt: formData.get('excerpt'),
                    content: content,
                    source_url: formData.get('source_url'),
                    source_title: formData.get('source_title')
                };
                
                // Zachov√°n√≠ souƒçasn√©ho obr√°zku pokud nen√≠ vybr√°n nov√Ω
                const currentArticle = await window.articleDB.getArticleById(articleId);
                articleData.image_url = currentArticle.image_url;
                
                // Nahr√°n√≠ nov√©ho obr√°zku pokud byl vybr√°n
                const imageFile = formData.get('image');
                if (imageFile && imageFile.size > 0) {
                    console.log('Nahr√°v√°m nov√Ω obr√°zek:', imageFile.name);
                    submitBtn.textContent = 'Nahr√°v√°m obr√°zek...';
                    const uploadResult = await window.articleDB.uploadImage(imageFile);
                    
                    if (uploadResult.success) {
                        articleData.image_url = uploadResult.url;
                        console.log('Nov√Ω obr√°zek nahr√°n:', uploadResult.url);
                    } else {
                        console.error('Chyba nahr√°v√°n√≠:', uploadResult.error);
                        alert('Chyba p≈ôi nahr√°v√°n√≠ obr√°zku: ' + uploadResult.error);
                        return;
                    }
                }
                
                submitBtn.textContent = 'Ukl√°d√°m ƒçl√°nek...';
                const result = await window.articleDB.updateArticle(articleId, articleData);
                console.log('V√Ωsledek aktualizace:', result);
                
                if (result.success) {
                    alert('ƒål√°nek byl √∫spƒõ≈°nƒõ aktualizov√°n!');
                    cancelEdit();
                    await loadArticles(); // Obnovit seznam ƒçl√°nk≈Ø
                } else {
                    alert('Chyba p≈ôi aktualizaci ƒçl√°nku: ' + result.error);
                }
            } catch (error) {
                console.error('Chyba p≈ôi aktualizaci ƒçl√°nku:', error);
                alert('Do≈°lo k chybƒõ p≈ôi aktualizaci ƒçl√°nku.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Funkce pro smaz√°n√≠ ƒçl√°nku
        async function deleteArticle(articleId, articleTitle) {
            if (!confirm(`Opravdu chcete smazat ƒçl√°nek "${articleTitle}"?\n\nTato akce je nevratn√°!`)) {
                return;
            }
            
            try {
                console.log('Ma≈æu ƒçl√°nek:', articleId, articleTitle);
                const result = await window.articleDB.deleteArticle(articleId);
                
                if (result.success) {
                    alert('ƒål√°nek byl √∫spƒõ≈°nƒõ smaz√°n!');
                    await loadArticles(); // Obnovit seznam ƒçl√°nk≈Ø
                } else {
                    alert('Chyba p≈ôi maz√°n√≠ ƒçl√°nku: ' + result.error);
                }
            } catch (error) {
                console.error('Chyba p≈ôi maz√°n√≠ ƒçl√°nku:', error);
                alert('Do≈°lo k chybƒõ p≈ôi maz√°n√≠ ƒçl√°nku.');
            }
        }

        // Funkce pro naƒçten√≠ obsahu str√°nky O projektu
        async function loadAboutPage() {
            const loadingEl = document.getElementById('about-loading');
            const titleEl = document.getElementById('about-title');
            
            try {
                loadingEl.style.display = 'block';
                
                const pageContent = await window.articleDB.getPageContent('about');
                
                if (pageContent) {
                    titleEl.value = pageContent.title;
                    window.aboutQuill.root.innerHTML = pageContent.content;
                } else {
                    // V√Ωchoz√≠ hodnoty pokud str√°nka neexistuje
                    titleEl.value = 'O projektu Vƒõdci zjistili';
                    window.aboutQuill.root.innerHTML = `
                        <p>Vƒõdci zjistili je projekt Milo≈°e ƒåerm√°ka, kter√Ω vznikl v r√°mci iniciativy Inspiruj.se. Jeho c√≠lem je uk√°zat, jak m≈Ø≈æe generativn√≠ AI pom√°hat p≈ôi popularizaci vƒõdy ‚Äì tedy p≈ôev√°dƒõt slo≈æit√© studie do srozumiteln√©ho, ƒçtiv√©ho a nƒõkdy i z√°bavn√©ho jazyka.</p>
                        <p>Na webu pravidelnƒõ zve≈ôej≈àujeme v√Ωbƒõr tƒõch nejzaj√≠mavƒõj≈°√≠ch vƒõdeck√Ωch studi√≠ a ƒçl√°nk≈Ø z cel√©ho svƒõta. Ka≈æd√° sumarizace vznik√° kombinac√≠ lidsk√©ho v√Ωbƒõru a √∫prav s asistenc√≠ generativn√≠ umƒõl√© inteligence. AI dƒõl√° vƒõt≈°inu pr√°ce, ale v≈°echno projde lidsk√Ωma oƒçima.</p>
                        <p>Projekt ukazuje, ≈æe AI nen√≠ jen n√°stroj pro v√Ωvoj√°≈ôe, ale m≈Ø≈æe b√Ωt i spoluautor ‚Äì t≈ôeba pr√°vƒõ v oblasti vƒõdeck√© ≈æurnalistiky. Pom√°h√° n√°m ≈°et≈ôit ƒças, t≈ô√≠dit informace a z√°rove≈à ps√°t tak, aby to ƒçten√°≈ôe bavilo.</p>
                        <p>Zaj√≠m√° v√°s, jak m≈Ø≈æete AI vyu≈æ√≠t ve sv√© profesi nebo kon√≠ƒçku? P≈ôesnƒõ to uƒç√≠me na na≈°ich kurzech a workshopech na <a href="https://inspiruj.se" target="_blank" rel="noopener">Inspiruj.se</a>.</p>
                    `;
                }
                
                loadingEl.style.display = 'none';
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ str√°nky O projektu:', error);
                loadingEl.style.display = 'none';
            }
        }

        // Funkce pro zpracov√°n√≠ formul√°≈ôe str√°nky O projektu
        async function handleAboutPageSubmit(e) {
            e.preventDefault();
            console.log('Formul√°≈ô str√°nky O projektu odesl√°n!');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                const formData = new FormData(this);
                
                // Z√≠sk√°n√≠ obsahu z Quill editoru
                const content = window.aboutQuill.root.innerHTML;
                console.log('Obsah str√°nky:', content);
                
                // Validace obsahu
                const textContent = window.aboutQuill.getText().trim();
                if (textContent.length === 0) {
                    alert('Pros√≠m vypl≈àte obsah str√°nky.');
                    return;
                }
                
                submitBtn.textContent = 'Ukl√°d√°m...';
                submitBtn.disabled = true;
                
                const result = await window.articleDB.updatePageContent(
                    'about',
                    formData.get('title'),
                    content
                );
                
                console.log('V√Ωsledek ulo≈æen√≠ str√°nky:', result);
                
                if (result.success) {
                    alert('Str√°nka O projektu byla √∫spƒõ≈°nƒõ ulo≈æena!');
                } else {
                    alert('Chyba p≈ôi ukl√°d√°n√≠ str√°nky: ' + result.error);
                }
            } catch (error) {
                console.error('Chyba p≈ôi ukl√°d√°n√≠ str√°nky:', error);
                alert('Do≈°lo k chybƒõ p≈ôi ukl√°d√°n√≠ str√°nky.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Newsletter funkce
        let newsletterGenerator = null;
        let emailService = null;

        // Inicializace newsletter dat
        async function loadNewsletterData() {
            // Inicializace newsletter generatoru
            newsletterGenerator = new NewsletterGenerator();
            await newsletterGenerator.loadTemplate();
            
            // Inicializace email slu≈æby
            emailService = new ResendEmailService();
            
            // Naƒçten√≠ statistik
            await loadNewsletterStats();
            
            // Naƒçten√≠ ƒçl√°nk≈Ø pro newsletter select
            await loadNewsletterArticles();
            
            // Test Resend p≈ôipojen√≠
            await testEmailConnection();
        }

        // Naƒçten√≠ newsletter statistik
        async function loadNewsletterStats() {
            const statsLoadingEl = document.getElementById('stats-loading');
            const statsContentEl = document.getElementById('stats-content');
            
            try {
                const stats = await window.articleDB.getNewsletterStats();
                
                if (stats) {
                    document.getElementById('active-subscribers').textContent = stats.activeSubscribers;
                    document.getElementById('total-emails').textContent = stats.totalEmailsSent;
                    document.getElementById('total-recipients').textContent = stats.totalRecipients;
                    
                    statsLoadingEl.style.display = 'none';
                    statsContentEl.style.display = 'block';
                } else {
                    statsLoadingEl.textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠ statistik';
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ statistik:', error);
                statsLoadingEl.textContent = 'Chyba p≈ôi naƒç√≠t√°n√≠ statistik';
            }
        }

        // Naƒçten√≠ ƒçl√°nk≈Ø pro newsletter
        async function loadNewsletterArticles() {
            const selectEl = document.getElementById('newsletter-article-select');
            const sendBtn = document.getElementById('send-newsletter-btn');
            
            try {
                const articles = await window.articleDB.getAllArticles();
                
                if (articles && articles.length > 0) {
                    selectEl.innerHTML = '<option value="">Vyberte ƒçl√°nek...</option>';
                    
                    articles.forEach(article => {
                        const option = document.createElement('option');
                        option.value = article.id;
                        option.textContent = `${window.articleDB.formatDate(article.date)} - ${article.title}`;
                        selectEl.appendChild(option);
                    });
                    
                    sendBtn.disabled = false;
                    
                    // Event listener pro preview
                    selectEl.addEventListener('change', showNewsletterPreview);
                } else {
                    selectEl.innerHTML = '<option value="">≈Ω√°dn√© ƒçl√°nky nejsou k dispozici</option>';
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ƒçl√°nk≈Ø:', error);
                selectEl.innerHTML = '<option value="">Chyba p≈ôi naƒç√≠t√°n√≠ ƒçl√°nk≈Ø</option>';
            }
        }

        // Zobrazen√≠ n√°hledu newsletteru
        async function showNewsletterPreview() {
            const selectEl = document.getElementById('newsletter-article-select');
            const previewEl = document.getElementById('newsletter-preview');
            const previewContentEl = document.getElementById('preview-content');
            
            const articleId = selectEl.value;
            
            if (!articleId) {
                previewEl.style.display = 'none';
                return;
            }
            
            try {
                const article = await window.articleDB.getArticleById(articleId);
                if (!article) {
                    previewEl.style.display = 'none';
                    return;
                }
                
                // Generov√°n√≠ n√°hledu emailu
                const emailHTML = newsletterGenerator.generateEmailHTML(article, 'preview-token');
                
                // Zobrazen√≠ v iframe pro bezpeƒçn√© zobrazen√≠
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '400px';
                iframe.style.border = '1px solid #ddd';
                iframe.style.borderRadius = '4px';
                
                previewContentEl.innerHTML = '';
                previewContentEl.appendChild(iframe);
                
                // Z√°pis HTML do iframe
                iframe.contentDocument.open();
                iframe.contentDocument.write(emailHTML);
                iframe.contentDocument.close();
                
                previewEl.style.display = 'block';
                
            } catch (error) {
                console.error('Chyba p≈ôi generov√°n√≠ n√°hledu:', error);
                previewContentEl.innerHTML = '<p style="color: #e74c3c;">Chyba p≈ôi generov√°n√≠ n√°hledu emailu.</p>';
                previewEl.style.display = 'block';
            }
        }

        // Test email p≈ôipojen√≠
        async function testEmailConnection() {
            // Email slu≈æba funguje p≈ôes Netlify Functions
            console.log('üìß Email slu≈æba je nakonfigurov√°na p≈ôes Netlify Functions');
            
            const statusEl = document.getElementById('newsletter-send-status');
            statusEl.textContent = 'Email slu≈æba je nakonfigurov√°na (Netlify Functions)';
            statusEl.style.color = '#27ae60';
        }

        // Odesl√°n√≠ newsletteru
        async function sendNewsletter() {
            const selectEl = document.getElementById('newsletter-article-select');
            const sendBtn = document.getElementById('send-newsletter-btn');
            const statusEl = document.getElementById('newsletter-send-status');
            
            const articleId = selectEl.value;
            
            if (!articleId) {
                alert('Pros√≠m vyberte ƒçl√°nek pro odesl√°n√≠.');
                return;
            }
            
            // Pozn√°mka: API kl√≠ƒç je nyn√≠ v Netlify environment variables
            
            // Potvrzen√≠ odesl√°n√≠
            if (!confirm('Opravdu chcete odeslat newsletter v≈°em odbƒõratel≈Øm?\n\nTato akce je nevratn√°!')) {
                return;
            }
            
            const originalText = sendBtn.textContent;
            
            try {
                sendBtn.disabled = true;
                sendBtn.textContent = 'Odes√≠l√°m...';
                statusEl.textContent = 'Naƒç√≠t√°n√≠ ƒçl√°nku a odbƒõratel≈Ø...';
                statusEl.style.color = '#666';
                
                // Naƒçten√≠ ƒçl√°nku a odbƒõratel≈Ø
                const [article, subscribers] = await Promise.all([
                    window.articleDB.getArticleById(articleId),
                    window.articleDB.getActiveSubscribers()
                ]);
                
                if (!article) {
                    throw new Error('ƒål√°nek nebyl nalezen');
                }
                
                if (!subscribers || subscribers.length === 0) {
                    throw new Error('≈Ω√°dn√≠ aktivn√≠ odbƒõratel√©');
                }
                
                // Odesl√°n√≠ pomoc√≠ Resend slu≈æby
                const results = await emailService.sendNewsletter(
                    article, 
                    subscribers, 
                    newsletterGenerator,
                    (current, total, email) => {
                        statusEl.textContent = `Odes√≠l√°n√≠ emailu ${current}/${total} (${email})...`;
                    }
                );
                
                // Zaznamen√°n√≠ odeslan√©ho emailu
                const subject = newsletterGenerator.generateSubject(article);
                await window.articleDB.logNewsletterEmail(article.id, subject, results.sent);
                
                // Obnoven√≠ statistik
                await loadNewsletterStats();
                
                // Zobrazen√≠ v√Ωsledk≈Ø
                if (results.sent > 0) {
                    statusEl.textContent = `Newsletter odesl√°n ${results.sent}/${subscribers.length} odbƒõratel≈Øm!`;
                    statusEl.style.color = '#27ae60';
                    
                    let message = `Newsletter byl √∫spƒõ≈°nƒõ odesl√°n ${results.sent} z ${subscribers.length} odbƒõratel≈Ø!`;
                    
                    if (results.failed > 0) {
                        message += `\n\nNe√∫spƒõ≈°n√Ωch: ${results.failed}`;
                        console.error('Chyby p≈ôi odes√≠l√°n√≠:', results.errors);
                    }
                    
                    alert(message);
                } else {
                    throw new Error('≈Ω√°dn√© emaily nebyly odesl√°ny');
                }
                
            } catch (error) {
                console.error('Chyba p≈ôi odes√≠l√°n√≠ newsletteru:', error);
                statusEl.textContent = `Chyba: ${error.message}`;
                statusEl.style.color = '#e74c3c';
                alert('Chyba p≈ôi odes√≠l√°n√≠ newsletteru: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = originalText;
                
                // Vyƒçi≈°tƒõn√≠ statusu po 15 sekund√°ch
                setTimeout(() => {
                    statusEl.textContent = '';
                    statusEl.style.color = '#666';
                }, 15000);
            }
        }

        // P≈ôid√°n√≠ odbƒõratele z admin rozhran√≠
        async function addSubscriberFromAdmin() {
            const emailInput = document.getElementById('add-subscriber-email');
            const messageEl = document.getElementById('add-subscriber-message');
            
            const email = emailInput.value.trim();
            
            if (!email) {
                showMessage(messageEl, 'Zadejte pros√≠m email adresu.', 'error');
                return;
            }
            
            // Validace emailu
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage(messageEl, 'Zadejte pros√≠m platn√Ω email.', 'error');
                return;
            }
            
            try {
                const result = await window.articleDB.addSubscriberAdmin(email);
                
                if (result.success) {
                    showMessage(messageEl, `Email ${email} byl √∫spƒõ≈°nƒõ p≈ôid√°n k odbƒõru.`, 'success');
                    emailInput.value = '';
                    
                    // Obnoven√≠ statistik a seznamu
                    await loadNewsletterStats();
                    if (document.getElementById('subscribers-list').style.display === 'block') {
                        await loadAllSubscribers();
                    }
                } else {
                    if (result.error.includes('duplicate key')) {
                        showMessage(messageEl, 'Tento email je ji≈æ p≈ôihl√°≈°en k odbƒõru.', 'error');
                    } else {
                        showMessage(messageEl, `Chyba p≈ôi p≈ôid√°v√°n√≠: ${result.error}`, 'error');
                    }
                }
            } catch (error) {
                console.error('Chyba p≈ôi p≈ôid√°v√°n√≠ odbƒõratele:', error);
                showMessage(messageEl, 'Do≈°lo k neoƒçek√°van√© chybƒõ.', 'error');
            }
        }

        // P≈ôep√≠n√°n√≠ zobrazen√≠ seznamu odbƒõratel≈Ø
        async function toggleSubscribersList() {
            const listEl = document.getElementById('subscribers-list');
            const btnEl = document.getElementById('toggle-subscribers-btn');
            
            if (listEl.style.display === 'none') {
                listEl.style.display = 'block';
                btnEl.textContent = 'Skr√Ωt seznam';
                await loadAllSubscribers();
            } else {
                listEl.style.display = 'none';
                btnEl.textContent = 'Zobrazit seznam';
            }
        }

        // Naƒçten√≠ v≈°ech odbƒõratel≈Ø
        async function loadAllSubscribers() {
            const loadingEl = document.getElementById('subscribers-loading');
            const contentEl = document.getElementById('subscribers-content');
            
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            
            try {
                const subscribers = await window.articleDB.getAllSubscribers();
                
                if (subscribers && subscribers.length > 0) {
                    const subscribersList = subscribers.map(subscriber => {
                        const date = new Date(subscriber.subscribed_at).toLocaleDateString('cs-CZ');
                        
                        // Status badge s ovƒõ≈ôen√≠m
                        let statusBadge = '';
                        if (!subscriber.verified) {
                            statusBadge = '<span style="background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">ƒåek√° na ovƒõ≈ôen√≠</span>';
                        } else if (subscriber.is_active) {
                            statusBadge = '<span style="background: #d4edda; color: #155724; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">Aktivn√≠</span>';
                        } else {
                            statusBadge = '<span style="background: #f8d7da; color: #721c24; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem;">Neaktivn√≠</span>';
                        }
                        
                        return `
                            <div style="padding: 0.75rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${subscriber.email}</strong><br>
                                    <small style="color: #666;">P≈ôihl√°≈°en: ${date}</small>
                                    ${!subscriber.verified ? '<br><small style="color: #856404;">‚ö†Ô∏è Neovƒõ≈ôen√Ω email</small>' : ''}
                                </div>
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    ${statusBadge}
                                    <button onclick="toggleSubscriberStatus(${subscriber.id}, ${!subscriber.is_active})" 
                                            class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #6c757d;"
                                            ${!subscriber.verified ? 'disabled title="Nelze aktivovat neovƒõ≈ôen√Ω email"' : ''}>
                                        ${subscriber.is_active ? 'Deaktivovat' : 'Aktivovat'}
                                    </button>
                                    <button onclick="deleteSubscriber(${subscriber.id}, '${subscriber.email}')" 
                                            class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; background: #dc3545;">
                                        Smazat
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    contentEl.innerHTML = `
                        <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #666;">
                            Celkem ${subscribers.length} odbƒõratel≈Ø:
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${subscribersList}
                        </div>
                    `;
                } else {
                    contentEl.innerHTML = '<div style="text-align: center; color: #666; padding: 2rem;">≈Ω√°dn√≠ odbƒõratel√©</div>';
                }
                
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ odbƒõratel≈Ø:', error);
                contentEl.innerHTML = '<div style="text-align: center; color: #e74c3c; padding: 2rem;">Chyba p≈ôi naƒç√≠t√°n√≠ seznamu</div>';
                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            }
        }

        // Aktivace/deaktivace odbƒõratele
        async function toggleSubscriberStatus(subscriberId, newStatus) {
            try {
                const result = await window.articleDB.toggleSubscriber(subscriberId, newStatus);
                
                if (result.success) {
                    await loadAllSubscribers();
                    await loadNewsletterStats();
                } else {
                    alert('Chyba p≈ôi zmƒõnƒõ stavu: ' + result.error);
                }
            } catch (error) {
                console.error('Chyba p≈ôi zmƒõnƒõ stavu odbƒõratele:', error);
                alert('Do≈°lo k neoƒçek√°van√© chybƒõ.');
            }
        }

        // Smaz√°n√≠ odbƒõratele
        async function deleteSubscriber(subscriberId, email) {
            if (!confirm(`Opravdu chcete smazat odbƒõratele "${email}"?\n\nTato akce je nevratn√°!`)) {
                return;
            }
            
            try {
                const result = await window.articleDB.deleteSubscriber(subscriberId);
                
                if (result.success) {
                    await loadAllSubscribers();
                    await loadNewsletterStats();
                    alert(`Odbƒõratel ${email} byl √∫spƒõ≈°nƒõ smaz√°n.`);
                } else {
                    alert('Chyba p≈ôi maz√°n√≠: ' + result.error);
                }
            } catch (error) {
                console.error('Chyba p≈ôi maz√°n√≠ odbƒõratele:', error);
                alert('Do≈°lo k neoƒçek√°van√© chybƒõ.');
            }
        }

        // Pomocn√° funkce pro zobrazov√°n√≠ zpr√°v
        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = type === 'success' ? 'success' : 'error';
            element.style.display = 'block';
            element.style.color = type === 'success' ? '#155724' : '#721c24';
            element.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
            element.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
            element.style.padding = '0.5rem';
            element.style.borderRadius = '4px';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // Newsletter toggle funkcionalita
        function initializeNewsletterToggle() {
            const toggle = document.getElementById('newsletter-toggle');
            const status = document.getElementById('newsletter-status');
            
            // Naƒçten√≠ stavu z localStorage
            const isEnabled = localStorage.getItem('newsletter-enabled') !== 'false';
            toggle.checked = isEnabled;
            updateNewsletterStatus(isEnabled);
            
            // Event listener pro zmƒõnu
            toggle.addEventListener('change', function() {
                const enabled = this.checked;
                localStorage.setItem('newsletter-enabled', enabled.toString());
                updateNewsletterStatus(enabled);
                updateMainPageNewsletter(enabled);
            });
        }
        
        function updateNewsletterStatus(enabled) {
            const status = document.getElementById('newsletter-status');
            if (enabled) {
                status.textContent = 'Zapnuto';
                status.style.color = '#27ae60';
            } else {
                status.textContent = 'Vypnuto';
                status.style.color = '#e74c3c';
            }
        }
        
        function updateMainPageNewsletter(enabled) {
            // Po≈°leme zpr√°vu do parent window (pokud je admin otev≈ôen√Ω v iframe)
            // nebo aktualizujeme pomoc√≠ postMessage API
            try {
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({
                        type: 'newsletter-toggle',
                        enabled: enabled
                    }, window.location.origin);
                }
            } catch (error) {
                console.log('Nelze komunikovat s parent window:', error);
            }
        }

    </script>
</body>
</html>